@model IEnumerable<inventario_coprotab.Models.DBInventario.Dispositivo>
@Html.AntiForgeryToken()

@{
    ViewData["Title"] = "Gestión de Dispositivos y Componentes";
    var componentes = ViewBag.Componentes as IEnumerable<inventario_coprotab.Models.DBInventario.Componente>;
}

@{
    ViewData["Title"] = "Gestión de Dispositivos y Componentes";
    var movimientos = ViewBag.Movimientos as IEnumerable<inventario_coprotab.Models.DBInventario.Movimiento>;
}

<div class="page-header d-flex justify-content-between align-items-center">
    <h1><i class="bi bi-laptop"></i> Gestión de Inventario</h1>
    <div class="d-flex gap-2">
       
        <button class="btn btn-primary-custom" onclick="abrirModalCrearDispositivo()">
            <i class="bi bi-plus-circle"></i> Nuevo Dispositivo
            
        </button>
        @* <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#createEquipoModal">
            <i class="bi bi-cpu"></i> Nuevo Equipo
        </button> *@
        <button class="btn btn-success-custom" onclick="abrirModalCrearComponente()">
            <i class="bi bi-gear"></i> Nuevo Componente
        </button>
    </div>
</div>

<!-- Filtros de búsqueda -->
<div class="card-custom p-4 mb-4">
    <h5 class="mb-3"><i class="bi bi-funnel"></i> Filtros de Búsqueda</h5>
    <form method="get" id="formFiltros">
        @Html.AntiForgeryToken()
        <div class="row g-3">
            <div class="col-md-3">
                <input type="text" name="searchNombre" class="form-control" placeholder="Buscar por nombre.." value="@ViewBag.SearchNombre" />
            </div>
            <div class="col-md-3">
                <input type="text" name="searchSerie" class="form-control" placeholder="Número de Serie" value="@ViewBag.SearchSerie" />
            </div>
            <div class="col-md-2">
                <input type="text" name="searchTipo" class="form-control" placeholder="Tipo" value="@ViewBag.SearchTipo" />
            </div>
            <div class="col-md-2">
                <select name="searchEstado" class="form-select">
                    <option value="">Todos los estados</option>
                    <option value="Nuevo" selected="@(ViewBag.SearchEstado == "Nuevo")">Nuevo</option>
                    <option value="En uso" selected="@(ViewBag.SearchEstado == "En uso")">En uso</option>
                    <option value="Obsoleto" selected="@(ViewBag.SearchEstado == "Obsoleto")">Obsoleto</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary-custom w-100">
                    <i class="bi bi-search"></i> Buscar
                </button>
            </div>
        </div>
        <div class="mt-2">
            @if (ViewBag.MostrarAlertas == true)
            {
                <a asp-action="Index" class="btn btn-secondary">
                    <i class="bi bi-list"></i> Ver Todos
                </a>
            }
            else
            {
                <a asp-action="Index" asp-route-mostrarAlertas="true" class="btn btn-warning">
                    <i class="bi bi-exclamation-triangle-fill"></i> Ver Alertas de Bajo Stock
                </a>
            }
        </div>
        <div class="mt-2">
            <a asp-action="Index" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-x-circle"></i> Limpiar Filtros
            </a>
        </div>
    </form>
</div>

<!-- ============================= SECCIÓN DISPOSITIVOS ============================= -->
<div class="card-custom p-4 mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0" style="color: var(--primary-color);">
            <i class="bi bi-laptop"></i>
            @if (ViewBag.MostrarAlertas == true)
            {
                <span>Dispositivos con Bajo Stock - Alertas</span>
            }
            else
            {
                <span>Últimos 5 Dispositivos (Hardware)</span>
            }
        </h3>
        <span class="badge bg-primary" style="font-size: 1rem;">@Model.Count() registros</span>
    </div>

    <!-- ✅ Contenedor con scroll -->
    <div class="table-responsive" style="max-height: 400px; overflow-y: auto; overflow-x: auto;">
        <table class="table table-custom table-hover">
            <thead style="position: sticky; top: 0; z-index: 10; background: var(--primary-color);">
                <tr>
                    <th><i class="bi bi-tag"></i> Nombre</th>
                    <th><i class="bi bi-card-text"></i> Descripción</th>
                    <th><i class="bi bi-upc"></i> Código</th>
                    <th class="text-center"><i class="bi bi-hash"></i> Identificación única</th>
                    <th><i class="bi bi-circle-fill"></i> Estado</th>
                    @* <th><i class="bi bi-calendar"></i> Fecha Alta</th> *@
                    <th><i class="bi bi-boxes"></i> Stock</th>
                    @* <th><i class="bi bi-bookmark"></i> Marca</th>
                    <th><i class="bi bi-cpu"></i> Tipo</th> *@
                    <th class="text-center"><i class="bi bi-gear"></i> Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    var rowClass = "";
                    if (item.StockActual == 0)
                    {
                        rowClass = "table-danger"; // Rojo para stock en 0
                    }
                    else if (item.StockActual <= item.StockMinimo)
                    {
                        rowClass = "table-warning"; // Amarillo para bajo stock
                    }

                    <tr class="@rowClass">
                        <td class="fw-bold">@item.Nombre</td>
                        <td>@(item.Descripcion ?? "Sin descripción")</td>
                        <td><span class="badge bg-secondary">@(item.CodigoInventario ?? "N/A")</span></td>
                        <td>@(item.NroSerie ?? "N/A")</td>
                        <td>
                            @if (item.Estado == "Nuevo")
                            {
                                <span class="badge badge-custom" style="background-color: var(--success-color);">
                                    <i class="bi bi-star-fill"></i> @item.Estado
                                </span>
                            }
                            else if (item.Estado == "En uso")
                            {
                                <span class="badge badge-custom" style="background-color: var(--secondary-color);">
                                    <i class="bi bi-check-circle-fill"></i> @item.Estado
                                </span>
                            }
                            else
                            {
                                <span class="badge badge-custom" style="background-color: var(--warning-color);">
                                    <i class="bi bi-exclamation-circle-fill"></i> @item.Estado
                                </span>
                            }
                        </td>
                        @* <td>@(item.FechaAlta?.ToString("dd/MM/yyyy") ?? "N/A")</td> *@
                        <td>
                            @if (item.StockActual == 0)
                            {
                                <span class="badge bg-danger" style="font-size: 0.9rem;">
                                    <i class="bi bi-x-circle-fill"></i> SIN STOCK
                                </span>
                            }
                            else if (item.StockActual <= item.StockMinimo)
                            {
                                <span class="badge bg-warning text-dark" style="font-size: 0.9rem;">
                                    <i class="bi bi-exclamation-triangle-fill"></i> @item.StockActual / @item.StockMinimo
                                </span>
                            }
                            else
                            {
                                <span class="badge bg-success">
                                    @item.StockActual unidades
                                </span>
                            }
                        </td>
                       @* <td>@(item.IdMarcaNavigation?.Nombre ?? "Sin marca")</td> 
                        <td>@(item.IdTipoNavigation?.Descripcion ?? "Sin tipo")</td> *@
                        <td class="text-center">
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-primary" onclick="abrirModalDetalleDispositivo(@item.IdDispositivo)" title="Ver Detalles">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning-custom" onclick="abrirModalEditarDispositivo(@item.IdDispositivo)" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-info" onclick="abrirModalMovimientoDispositivo(@item.IdDispositivo)" title="Crear Movimiento">
                                    <i class="bi bi-arrow-left-right"></i>
                                </button>
                                <button class="btn btn-sm btn-danger-custom" onclick="abrirModalEliminarDispositivo(@item.IdDispositivo, '@item.Nombre')" title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                                
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @if (!Model.Any())
    {
        <div class="alert alert-info text-center">
            <i class="bi bi-info-circle"></i> No se encontraron dispositivos con los criterios de búsqueda especificados.
        </div>
    }
</div>

<!-- ============================= SECCIÓN COMPONENTES ============================= -->
<div class="card-custom p-4 mb-4" style="border-left: 4px solid var(--success-color);">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0" style="color: var(--primary-color);">
            <i class="bi bi-laptop"></i>
            @if (ViewBag.MostrarAlertas == true)
            {
                <span>Componentes con Bajo Stock - Alertas</span>
            }
            else
            {
                <span>Últimos 5 Componentes (Hardware Interno, Insumos, Cables)</span>
            }
        </h3>
        <span class="badge bg-primary" style="font-size: 1rem;">@(componentes?.Count() ?? 0) registros</span>
    </div>

    @* <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0" style="color: var(--success-color);">
            <i class="bi bi-gear-fill"></i> Últimos 5 Componentes (Hardware Interno, Insumos, Cables...)
        </h3>
        <span class="badge bg-success" style="font-size: 1rem;">@(componentes?.Count() ?? 0) registros</span>
    </div> *@

    <!-- ✅ Contenedor con scroll -->
    <div class="table-responsive" style="max-height: 400px; overflow-y: auto; overflow-x: auto;">
        <table class="table table-custom table-hover">
            <thead style="position: sticky; top: 0; z-index: 10; background: var(--success-color);">
                <tr>
                    <th><i class="bi bi-tag"></i> Nombre</th>
                    <th><i class="bi bi-card-text"></i> Descripción</th>
                    <th><i class="bi bi-hash"></i> Nro. Serie</th>
                    <th><i class="bi bi-circle-fill"></i> Estado</th>
                    @* <th><i class="bi bi-bookmark"></i> Marca</th> *@
                    <th><i class="bi bi-cpu"></i> Tipo</th>
                    @* <th><i class="bi bi-calendar"></i> Fecha Instalación</th> *@
                    <th><i class="bi bi-box-seam"></i> Stock</th>

                    <th class="text-center"><i class="bi bi-gear"></i> Acciones</th>
                </tr>
            </thead>
            <tbody>
               

                @if (componentes != null && componentes.Any())
                {
                    @foreach (var comp in componentes)
                    {
                        var rowComp = "";
                        if (comp.Cantidad == 0)
                        {
                            rowComp = "table-danger"; // Rojo para stock en 0
                        }
                        else if (comp.Cantidad <= comp.StockMinimo)
                        {
                            rowComp = "table-warning"; // Amarillo para bajo stock
                        }
                        <tr class="@rowComp">
              
                            <td class="fw-bold">@comp.Nombre</td>
                            <td>@(comp.Descripcion ?? "Sin descripción")</td>
                            <td>
                                @if (!string.IsNullOrEmpty(comp.NroSerie))
                                {
                                    <code>@comp.NroSerie</code>
                                }
                                else
                                {
                                    <span class="text-muted">N/A</span>
                                }
                            </td>
                            <td>
                                @if (comp.Estado == "Nuevo")
                                {
                                    <span class="badge badge-custom" style="background-color: var(--success-color);">
                                        <i class="bi bi-star-fill"></i> @comp.Estado
                                    </span>
                                }
                                else if (comp.Estado == "En uso")
                                {
                                    <span class="badge badge-custom" style="background-color: var(--secondary-color);">
                                        <i class="bi bi-check-circle-fill"></i> @comp.Estado
                                    </span>
                                }
                                else
                                {
                                    <span class="badge badge-custom" style="background-color: var(--warning-color);">
                                        <i class="bi bi-exclamation-circle-fill"></i> @(comp.Estado ?? "N/A")
                                    </span>
                                }
                            </td>
                            @* <td>@(comp.IdMarcaNavigation?.Nombre ?? "Sin marca")</td> *@
                            <td>@(comp.IdTipoNavigation?.Descripcion ?? "Sin tipo")</td>
                           @*  <td>@(comp.FechaInstalacion?.ToString("dd/MM/yyyy") ?? "N/A")</td> *@
                            @* <td>
                                <span class="badge bg-info">@comp.Cantidad</span>
                            </td> *@
                            <td>
                                @if (comp.Cantidad == 0)
                                {
                                    <span class="badge bg-danger" style="font-size: 0.9rem;">
                                        <i class="bi bi-x-circle-fill"></i> SIN STOCK
                                    </span>
                                }
                                else if (comp.Cantidad <= comp.StockMinimo)
                                {
                                    <span class="badge bg-warning text-dark" style="font-size: 0.9rem;">
                                        <i class="bi bi-exclamation-triangle-fill"></i> @comp.Cantidad / @comp.StockMinimo
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-success">
                                        @comp.Cantidad unidades
                                    </span>
                                }
                            </td>

                            <td class="text-center">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="abrirModalDetalleComponente(@comp.IdComponente)" title="Ver Detalles">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-warning-custom" onclick="abrirModalEditarComponente(@comp.IdComponente)" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <!-- ✅ NUEVO: Botón de movimiento para componentes -->
                                    <button class="btn btn-sm btn-info" onclick="abrirModalMovimientoComponente(@comp.IdComponente)" title="Crear Movimiento">
                                        <i class="bi bi-arrow-left-right"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger-custom" onclick="abrirModalEliminarComponente(@comp.IdComponente, '@comp.Nombre')" title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    @if (componentes == null || !componentes.Any())
    {
        <div class="alert alert-info text-center">
            <i class="bi bi-info-circle"></i> No se encontraron componentes con los criterios de búsqueda especificados.
        </div>
    }
</div>

<!-- Sección de Movimientos de Dispositivos -->
<div class="card-custom p-4 mb-4" style="border-left: 4px solid var(--secondary-color);">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0" style="color: var(--secondary-color);">
            <i class="bi bi-arrow-left-right"></i> Últimos 5 Movimientos de Dispositivos
        </h3>
        <span class="badge bg-info" style="font-size: 1rem;">@(movimientos?.Count() ?? 0) registros</span>
    </div>

    <!-- ✅ Contenedor con scroll -->
    <div class="table-responsive" style="max-height: 400px; overflow-y: auto; overflow-x: auto;">
        <table class="table table-custom table-hover">
            <thead style="position: sticky; top: 0; z-index: 10; background: var(--secondary-color);">
                <tr>
                    <th><i class="bi bi-tag"></i> Nombre de Dispositivo</th>
                    <th><i class="bi bi-card-text"></i> Tipo de Movimiento</th>
                    <th><i class="bi bi-hash"></i> Cantidad</th>
                    <th><i class="bi bi-circle-fill"></i> Ubicacion</th>
                    <th><i class="bi bi-bookmark"></i> Responsable</th>
                    <th><i class="bi bi-cpu"></i> Observaciones</th>
                    <th><i class="bi bi-calendar"></i> Fecha</th>
                    <th class="text-center"><i class="bi bi-gear"></i> Acciones</th>
                </tr>
            </thead>
            <tbody>
                @if (movimientos != null && movimientos.Any())
                { 
                    @foreach (var movi in movimientos)
                    {
                        <tr>
                            <td class="fw-bold">@movi.IdDispositivoNavigation?.Nombre</td>
                            <td>
                                @if (movi.TipoMovimiento == "Entrada")
                                {
                                    <span class="badge badge-custom" style="background-color: var(--success-color);">
                                        <i class="bi bi-box-arrow-in-down"></i> @movi.TipoMovimiento
                                    </span>
                                }
                                else if (movi.TipoMovimiento == "Salida")
                                {
                                    <span class="badge badge-custom" style="background-color: var(--accent-color);">
                                        <i class="bi bi-box-arrow-up"></i> @movi.TipoMovimiento
                                    </span>
                                }
                                else
                                {
                                    <span class="badge badge-custom" style="background-color: var(--warning-color);">
                                        <i class="bi bi-arrow-left-right"></i> @(movi.TipoMovimiento ?? "N/A")
                                    </span>
                                }
                            </td>
                            <td>@(movi.Cantidad)</td>
                            <td>@(movi.IdUbicacionNavigation?.Nombre ?? "N/A")</td>
                            <td>@(movi.IdResponsableNavigation?.Nombre ?? "N/A")</td>
                            <td>@(movi.Observaciones ?? "N/A")</td>
                            <td>@(movi.Fecha.ToString("dd/MM/yyyy HH:mm"))</td>
                            <td class="text-center">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="abrirModalDetalleMovimiento(@movi.IdMovimiento)" title="Ver Detalles">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-warning-custom" onclick="abrirModalEditarMovimiento(@movi.IdMovimiento)" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger-custom" onclick="abrirModalEliminarMovimiento(@movi.IdMovimiento, '@movi.IdDispositivoNavigation.Nombre')" title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                 } 
            </tbody>
        </table>
    </div>

    @if (movimientos == null || !movimientos.Any())
    {
        <div class="alert alert-info text-center">
            <i class="bi bi-info-circle"></i> No se encontraron movimientos de dispositivos registrados.
        </div>
    }
</div>

<!-- ✅ NUEVA SECCIÓN: Movimientos de Componentes -->
@{
    var movimientosComponentes = ViewBag.MovimientosComponentes as IEnumerable<inventario_coprotab.Models.DBInventario.Movimiento>;
}
@if (movimientosComponentes != null && movimientosComponentes.Any())
{
    <div class="card-custom p-4 mb-4" style="border-left: 4px solid var(--success-color);">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0" style="color: var(--success-color);">
                <i class="bi bi-gear-fill"></i> Últimos 5 Movimientos de Componentes
            </h3>
            <span class="badge bg-success" style="font-size: 1rem;">@movimientosComponentes.Count() registros</span>
        </div>

        <div class="table-responsive" style="max-height: 400px; overflow-y: auto; overflow-x: auto;">
            <table class="table table-custom table-hover">
                <thead style="position: sticky; top: 0; z-index: 10; background: var(--success-color);">
                    <tr>
                        <th><i class="bi bi-gear"></i> Componente</th>
                        <th><i class="bi bi-card-text"></i> Tipo de Movimiento</th>
                        <th><i class="bi bi-hash"></i> Cantidad</th>
                        <th><i class="bi bi-circle-fill"></i> Ubicacion</th>
                        <th><i class="bi bi-bookmark"></i> Responsable</th>
                        <th><i class="bi bi-cpu"></i> Observaciones</th>
                        <th><i class="bi bi-calendar"></i> Fecha</th>
                        <th class="text-center"><i class="bi bi-gear"></i> Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var movi in movimientosComponentes)
                    {
                        <tr>
                            <td class="fw-bold">
                                @(movi.IdComponenteNavigation?.Nombre ?? "Sin nombre")
                            </td>
                            <td>
                                @if (movi.TipoMovimiento == "Entrada")
                                {
                                    <span class="badge badge-custom" style="background-color: var(--success-color);">
                                        <i class="bi bi-box-arrow-in-down"></i> @movi.TipoMovimiento
                                    </span>
                                }
                                else if (movi.TipoMovimiento == "Salida")
                                {
                                    <span class="badge badge-custom" style="background-color: var(--accent-color);">
                                        <i class="bi bi-box-arrow-up"></i> @movi.TipoMovimiento
                                    </span>
                                }
                                else
                                {
                                    <span class="badge badge-custom" style="background-color: var(--warning-color);">
                                        <i class="bi bi-arrow-left-right"></i> @movi.TipoMovimiento
                                    </span>
                                }
                            </td>
                            <td>@movi.Cantidad</td>
                            <td>@(movi.IdUbicacionNavigation?.Nombre ?? "N/A")</td>
                            <td>@(movi.IdResponsableNavigation?.Nombre ?? "N/A")</td>
                            <td>@(movi.Observaciones ?? "N/A")</td>
                            <td>@movi.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
                            <td class="text-center">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="abrirModalDetalleMovimiento(@movi.IdMovimiento)" title="Ver Detalles">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger-custom" onclick="abrirModalEliminarMovimiento(@movi.IdMovimiento)" title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

<!-- Modal Dispositivo (Crear/Editar/Detalle/Eliminar) -->
<div class="modal fade" id="modalDispositivo" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: var(--success-color); color: white;">
                <h5 class="modal-title" id="modalDispositivoTitulo"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: brightness(0) invert(1);"></button>
            </div>
            <div class="modal-body" id="modalDispositivoContenido"></div>
        </div>
    </div>
</div>

@* <!-- Modal Crear/Editar Dispositivos -->
<div class="modal fade" id="modalFormulario" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title" id="modalTitulo">
                    <i class="bi bi-plus-circle"></i> Nuevo Dispositivo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalContenido"></div>
        </div>
    </div>
</div>

<!-- Modal Detalle Dispositivos -->
<div class="modal fade" id="modalDetalle" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title">
                    <i class="bi bi-info-circle"></i> Detalles del Dispositivo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalDetalleContenido"></div>
        </div>
    </div>
</div>

<!-- Modal Eliminar Dispositivos -->
<div class="modal fade" id="modalEliminar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i> Confirmar Eliminación
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro que desea eliminar el dispositivo <strong id="nombreDispositivo"></strong>?</p>
                <p class="text-muted small">Esta acción realizará un borrado lógico del registro.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger-custom" id="btnConfirmarEliminar">
                    <i class="bi bi-trash"></i> Eliminar
                </button>
            </div>
        </div>
    </div>
</div> *@

<!-- Modal Crear Equipo -->
<div class="modal fade" id="createEquipoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title">Nuevo Equipo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body"></div>
        </div>
    </div>
</div>

<!-- Modal Componentes (Crear/Editar/Detalle/Eliminar) -->
<div class="modal fade" id="modalComponente" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: var(--success-color); color: white;">
                <h5 class="modal-title" id="modalComponenteTitulo"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: brightness(0) invert(1);"></button>
            </div>
            <div class="modal-body" id="modalComponenteContenido"></div>
        </div>
    </div>
</div>

<!-- Modal Movimiento -->
<div class="modal fade" id="modalMovimiento" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: var(--success-color); color: white;">
                <h5 class="modal-title" id="modalMovimientoTitulo"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalMovimientoContenido"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let dispositivoIdEliminar = null;
        let componenteIdEliminar = null;
        let movimientoIdEliminar = null;

        // ==================== FUNCIONES DISPOSITIVOS ====================
        function abrirModalCrearDispositivo() {
             $('#modalDispositivoTitulo').html('<i class="bi bi-plus-circle"></i> Nuevo Dispositivo');
             $.get('@Url.Action("Create", "Dispositivo")', function(data) {
                 $('#modalDispositivoContenido').html(data);
                 $('#modalDispositivo').modal('show');
             }).fail(function() {
                 alert('Error al cargar el formulario de Dispositivo');
             });
         }

        function abrirModalEditarDispositivo(id) {
                    $('#modalDispositivoTitulo').html('<i class="bi bi-pencil"></i> Editar Dispositivo');
                    $.get('@Url.Action("Edit", "Dispositivo")/' + id, function(data) {
                        $('#modalDispositivoContenido').html(data);
                        $('#modalDispositivo').modal('show');
                    }).fail(function() {
                        alert('Error al cargar el formulario de edición');
                    });
        }

        function abrirModalDetalleDispositivo(id) {
                    $('#modalDispositivoTitulo').html('<i class="bi bi-info-circle"></i> Detalles del Dispositivo');
                    $.get('@Url.Action("Details", "Dispositivo")/' + id, function(data) {
                        $('#modalDispositivoContenido').html(data);
                        $('#modalDispositivo').modal('show');
                    }).fail(function() {
                        alert('Error al cargar los detalles');
                    });
        }

        function abrirModalEliminarDispositivo(id, nombre) {
                    if (confirm('¿Está seguro que desea eliminar el Dispositivo "' + nombre + '"?')) {
                        $.ajax({
                            url: '@Url.Action("Delete", "Dispositivo")/' + id,
                            type: 'POST',
                            data: {
                                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                            },
                            success: function(response) {
                                if (response.success) {
                                    location.reload();
                                } else {
                                    alert('Error al eliminar el Dispositivo');
                                }
                            },
                            error: function() {
                                alert('Error al procesar la solicitud');
                            }
                        });
                    }
        }

                // Manejar submit del formulario de componentes (crear)
        $(document).on('submit', '#formDispositivo', function(e) {
                    e.preventDefault();
                    var form = $(this);
                    $.ajax({
                        url: form.attr('action'),
                        type: 'POST',
                        data: form.serialize(),
                        success: function(response) {
                            if (response.success) {
                                $('#modalDispositivo').modal('hide');
                                location.reload();
                            } else {
                                $('#modalDispositivoContenido').html(response);
                            }
                        },
                        error: function() {
                            alert('Error al procesar la solicitud');
                        }
                    });
        });

                // Manejar submit del formulario de edición de componentes
        $(document).on('submit', '#formDispositivoEdit', function(e) {
                    e.preventDefault();
                    var form = $(this);

                    $.ajax({
                        url: 'Url.Action("Edit", "Dispositivo")',
                        type: 'POST',
                        data: form.serialize(),
                        success: function(response) {
                            if (response.success) {
                                $('#modalDispositivo').modal('hide');
                                location.reload();
                            } else {
                                $('#modalDispositivoContenido').html(response);
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('Error:', error);
                            console.log('Response:', xhr.responseText);
                            alert('Error al procesar la solicitud de edición');
                        }
                    });
        });



        // function abrirModalCrear() {
        //     $('#modalTitulo').html('<i class="bi bi-plus-circle"></i> Nuevo Dispositivo');
        //     $.get('Url.Action("Create", "Dispositivo")', function(data) {
        //         $('#modalContenido').html(data);
        //         $('#modalFormulario').modal('show');
        //     }).fail(function() {
        //         alert('Error al cargar el formulario');
        //     });
        // }

        // function abrirModalEditarDispositivo(id) {
        //     $('#modalDispositivoTitulo').html('<i class="bi bi-pencil"></i> Editar Dispositivo');
        //     $.get('Url.Action("Edit", "Dispositivo")/' + id, function(data) {
        //         $('#modalDispositivoContenido').html(data);
        //         $('#modalDispositivo').modal('show');
        //     }).fail(function() {
        //         alert('Error al cargar el formulario de edición');
        //     });
        // }

        // function abrirModalDetalle(id) {
        //     $.get('Url/* .Action("Details", "Dispositivo") *//' + id, function(data) {
        //         $('#modalDetalleContenido').html(data);
        //         $('#modalDetalle').modal('show');
        //     }).fail(function() {
        //         alert('Error al cargar los detalles');
        //     });
        // }

        // function abrirModalEliminar(id, nombre) {
        //     dispositivoIdEliminar = id;
        //     $('#nombreDispositivo').text(nombre);
        //     $('#modalEliminar').modal('show');
        // }

        // $('#btnConfirmarEliminar').click(function() {
        //     if (dispositivoIdEliminar) {
        //         $.ajax({
        //             url: 'Url/* .Action("Delete", "Dispositivo") *//' + dispositivoIdEliminar,
        //             type: 'POST',
        //             data: {
        //                 __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val(),
        //                 id: dispositivoIdEliminar
        //             },
        //             success: function(response) {
        //                 if (response.success) {
        //                     $('#modalEliminar').modal('hide');
        //                     location.reload();
        //                 } else {
        //                     alert('Error al eliminar el dispositivo');
        //                 }
        //             },
        //             error: function() {
        //                 alert('Error al eliminar el dispositivo');
        //             }
        //         });
        //     }
        // });

        // // Manejar submit del formulario de creación de dispositivos
        // $(document).on('submit', '#formDispositivo', function(e) {
        //     e.preventDefaf();
        //     var form = $(this);
        //     $.ajax({
        //         url: form.attr('action'),
        //         type: 'POST',
        //         data: form.serialize(),
        //         success: function(response) {
        //             if (response.success) {
        //                 $('#modalFormulario').modal('hide');
        //                 location.reload();
        //             } else {
        //                 $('#modalContenido').html(response);
        //             }
        //         },
        //         error: function() {
        //             alert('Error al procesar la solicitud');
        //         }
        //     });
        // });

        // // Manejar submit del formulario de edición de dispositivos
        // $(document).on('submit', '#formDispositivoEdit', function(e) {
        //     e.preventDefault();
        //     var form = $(this);

        //     $.ajax({
        //         url: 'Url/* .Action("Edit", "Dispositivo") */',
        //         type: 'POST',
        //         data: form.serialize(),
        //         success: function(response) {
        //             if (response.success) {
        //                 $('#modalFormulario').modal('hide');
        //                 location.reload();
        //             } else {
        //                 $('#modalContenido').html(response);
        //             }
        //         },
        //         error: function(xhr, status, error) {
        //             console.error('Error:', error);
        //             console.log('Response:', xhr.responseText);
        //             alert('Error al procesar la solicitud de edición');
        //         }
        //     });
        // });

        // ==================== FUNCIONES COMPONENTES ====================
        function abrirModalCrearComponente() {
            $('#modalComponenteTitulo').html('<i class="bi bi-plus-circle"></i> Nuevo Componente');
            $.get('@Url.Action("Create", "Componente")', function(data) {
                $('#modalComponenteContenido').html(data);
                $('#modalComponente').modal('show');
            }).fail(function() {
                alert('Error al cargar el formulario de componente');
            });
        }

        function abrirModalEditarComponente(id) {
            $('#modalComponenteTitulo').html('<i class="bi bi-pencil"></i> Editar Componente');
            $.get('@Url.Action("Edit", "Componente")/' + id, function(data) {
                $('#modalComponenteContenido').html(data);
                $('#modalComponente').modal('show');
            }).fail(function() {
                alert('Error al cargar el formulario de edición');
            });
        }

        function abrirModalDetalleComponente(id) {
            $('#modalComponenteTitulo').html('<i class="bi bi-info-circle"></i> Detalles del Componente');
            $.get('@Url.Action("Details", "Componente")/' + id, function(data) {
                $('#modalComponenteContenido').html(data);
                $('#modalComponente').modal('show');
            }).fail(function() {
                alert('Error al cargar los detalles');
            });
        }

        function abrirModalEliminarComponente(id, nombre) {
            if (confirm('¿Está seguro que desea eliminar el componente "' + nombre + '"?')) {
                $.ajax({
                    url: '@Url.Action("Delete", "Componente")/' + id,
                    type: 'POST',
                    data: {
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            alert('Error al eliminar el componente');
                        }
                    },
                    error: function() {
                        alert('Error al procesar la solicitud');
                    }
                });
            }
        }

        // Manejar submit del formulario de componentes (crear)
        $(document).on('submit', '#formComponente', function(e) {
            e.preventDefault();
            var form = $(this);
            $.ajax({
                url: form.attr('action'),
                type: 'POST',
                data: form.serialize(),
                success: function(response) {
                    if (response.success) {
                        $('#modalComponente').modal('hide');
                        location.reload();
                    } else {
                        $('#modalComponenteContenido').html(response);
                    }
                },
                error: function() {
                    alert('Error al procesar la solicitud');
                }
            });
        });

        // Manejar submit del formulario de edición de componentes
        $(document).on('submit', '#formComponenteEdit', function(e) {
            e.preventDefault();
            var form = $(this);

            $.ajax({
                url: '@Url.Action("Edit", "Componente")',
                type: 'POST',
                data: form.serialize(),
                success: function(response) {
                    if (response.success) {
                        $('#modalComponente').modal('hide');
                        location.reload();
                    } else {
                        $('#modalComponenteContenido').html(response);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    console.log('Response:', xhr.responseText);
                    alert('Error al procesar la solicitud de edición');
                }
            });
        });

        // ==================== FUNCIONES MOVIMIENTOS ====================

        // ✅ PARA DISPOSITIVOS
        function abrirModalMovimientoDispositivo(idDispositivo) {
            console.log('Abriendo modal para dispositivo:', idDispositivo); // Debug
            $('#modalMovimientoTitulo').html('<i class="bi bi-arrow-left-right"></i> Nuevo Movimiento - Dispositivo');

            $.get('@Url.Action("CreateForDispositivo", "Movimiento")/' + idDispositivo, function(data) {
                $('#modalMovimientoContenido').html(data);
                $('#modalMovimiento').modal('show');
            }).fail(function(xhr, status, error) {
                console.error('Error:', error);
                console.log('Response:', xhr.responseText);
                alert('Error al cargar el formulario de Movimiento para dispositivo');
            });
        }

        // ✅ PARA COMPONENTES
        function abrirModalMovimientoComponente(idComponente) {
            console.log('Abriendo modal para componente:', idComponente); // Debug
            $('#modalMovimientoTitulo').html('<i class="bi bi-arrow-left-right"></i> Nuevo Movimiento - Componente');

            $.get('@Url.Action("CreateForComponente", "Movimiento")/' + idComponente, function(data) {
                $('#modalMovimientoContenido').html(data);
                $('#modalMovimiento').modal('show');
            }).fail(function(xhr, status, error) {
                console.error('Error:', error);
                console.log('Response:', xhr.responseText);
                alert('Error al cargar el formulario de Movimiento para componente');
            });
        }

        function abrirModalEditarMovimiento(id) {
            $('#modalMovimientoTitulo').html('<i class="bi bi-pencil"></i> Editar Movimiento');
            $.get('@Url.Action("Edit", "Movimiento")/' + id, function(data) {
                $('#modalMovimientoContenido').html(data);
                $('#modalMovimiento').modal('show');
            }).fail(function() {
                alert('Error al cargar el formulario de edición');
            });
        }

        function abrirModalDetalleMovimiento(id) {
            $('#modalMovimientoTitulo').html('<i class="bi bi-info-circle"></i> Detalles del Movimiento');
            $.get('@Url.Action("Details", "Movimiento")/' + id, function(data) {
                $('#modalMovimientoContenido').html(data);
                $('#modalMovimiento').modal('show');
            }).fail(function() {
                alert('Error al cargar los detalles');
            });
        }

        function abrirModalEliminarMovimiento(id) {
            if (confirm('¿Está seguro que desea eliminar este Movimiento? Esta acción no se puede deshacer.')) {
                $.ajax({
                    url: '@Url.Action("Delete", "Movimiento")/' + id,
                    type: 'POST',
                    data: {
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            alert('Error al eliminar el movimiento');
                        }
                    },
                    error: function() {
                        alert('Error al procesar la solicitud');
                    }
                });
            }
        }

        

        // Manejar submit del formulario de edición de Movimiento
        $(document).on('submit', '#formMovimientoEdit', function(e) {
            e.preventDefault();
            var form = $(this);

            $.ajax({
                url: '@Url.Action("Edit", "Movimiento")',
                type: 'POST',
                data: form.serialize(),
                success: function(response) {
                    if (response.success) {
                        $('#modalMovimiento').modal('hide');
                        location.reload();
                    } else {
                        $('#modalMovimientoContenido').html(response);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    console.log('Response:', xhr.responseText);
                    alert('Error al procesar la solicitud de edición');
                }
            });
        });


        // Cargar formulario al abrir el modal
        $('#createEquipoModal').on('show.bs.modal', function () {
            var modal = $(this);
            modal.find('.modal-body').html('<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>');
            $.get(baseUrl + 'Dispositivo/CreateEquipo', function (data) {
                modal.find('.modal-body').html(data);
            });
        });

        // Limpiar modal al cerrar
        $('#createEquipoModal').on('hidden.bs.modal', function () {
            $(this).find('.modal-body').empty();
        });

        // ✅ Manejar submit del formulario de equipo
        $(document).on('submit', '#formEquipo', function(e) {
            e.preventDefault();
            var form = $(this);
    
            console.log('Enviando formulario de equipo');
            console.log('Datos:', form.serialize());
    
            $.ajax({
                url: form.attr('action'),
                type: 'POST',
                data: form.serialize(),
                success: function(response) {
                    console.log('Respuesta:', response);
                    if (response.success) {
                        $('#createEquipoModal').modal('hide');
                        // Pequeño delay para que se cierre el modal
                        setTimeout(function() {
                            location.reload();
                        }, 300);
                    } else {
                        // Si hay errores, mostrar el formulario actualizado
                        $('#createEquipoModal .modal-body').html(response);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    console.log('Response:', xhr.responseText);
                    alert('Error al procesar la solicitud: ' + error);
                }
            });
        });
    </script>
}