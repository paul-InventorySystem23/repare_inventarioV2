@model IEnumerable<inventario_coprotab.Models.DBInventario.Dispositivo>
@Html.AntiForgeryToken()

@{
    ViewData["Title"] = "Gestión de Dispositivos y Componentes";
    var componentes = ViewBag.Componentes as IEnumerable<inventario_coprotab.Models.DBInventario.Componente>;
}

<div class="page-header d-flex justify-content-between align-items-center">
    <h1><i class="bi bi-laptop"></i> Gestión de Inventario</h1>
    <div class="d-flex gap-2">
        <button class="btn btn-primary-custom" onclick="abrirModalCrear()">
            <i class="bi bi-plus-circle"></i> Nuevo Dispositivo
        </button>
        <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#createEquipoModal">
            <i class="bi bi-cpu"></i> Nuevo Equipo
        </button>
        <button class="btn btn-success-custom" onclick="abrirModalCrearComponente()">
            <i class="bi bi-gear"></i> Nuevo Componente
        </button>
    </div>
</div>

<!-- Filtros de búsqueda -->
<div class="card-custom p-4 mb-4">
    <h5 class="mb-3"><i class="bi bi-funnel"></i> Filtros de Búsqueda</h5>
    <form method="get" id="formFiltros">
        @Html.AntiForgeryToken()
        <div class="row g-3">
            <div class="col-md-3">
                <input type="text" name="searchCode" class="form-control" placeholder="Código de Inventario" value="@ViewBag.SearchCode" />
            </div>
            <div class="col-md-3">
                <input type="text" name="searchSerie" class="form-control" placeholder="Número de Serie" value="@ViewBag.SearchSerie" />
            </div>
            <div class="col-md-2">
                <input type="text" name="searchTipo" class="form-control" placeholder="Tipo" value="@ViewBag.SearchTipo" />
            </div>
            <div class="col-md-2">
                <select name="searchEstado" class="form-select">
                    <option value="">Todos los estados</option>
                    <option value="Nuevo" selected="@(ViewBag.SearchEstado == "Nuevo")">Nuevo</option>
                    <option value="En uso" selected="@(ViewBag.SearchEstado == "En uso")">En uso</option>
                    <option value="Obsoleto" selected="@(ViewBag.SearchEstado == "Obsoleto")">Obsoleto</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary-custom w-100">
                    <i class="bi bi-search"></i> Buscar
                </button>
            </div>
        </div>
        <div class="mt-2">
            <a asp-action="Index" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-x-circle"></i> Limpiar Filtros
            </a>
        </div>
    </form>
</div>

<!-- ============================= SECCIÓN DISPOSITIVOS ============================= -->
<div class="card-custom p-4 mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0" style="color: var(--primary-color);">
            <i class="bi bi-laptop"></i> Dispositivos (Hardware y Consumibles)
        </h3>
        <span class="badge bg-primary" style="font-size: 1rem;">@Model.Count() registros</span>
    </div>

    <div class="table-responsive">
        <table class="table table-custom table-hover">
            <thead>
                <tr>
                    <th><i class="bi bi-tag"></i> Nombre</th>
                    <th><i class="bi bi-card-text"></i> Descripción</th>
                    <th><i class="bi bi-upc"></i> Código</th>
                    <th><i class="bi bi-hash"></i> Serie</th>
                    <th><i class="bi bi-circle-fill"></i> Estado</th>
                    <th><i class="bi bi-calendar"></i> Fecha Alta</th>
                    <th><i class="bi bi-boxes"></i> Stock</th>
                    <th><i class="bi bi-bookmark"></i> Marca</th>
                    <th><i class="bi bi-cpu"></i> Tipo</th>
                    <th class="text-center"><i class="bi bi-gear"></i> Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td class="fw-bold">@item.Nombre</td>
                        <td>@(item.Descripcion ?? "Sin descripción")</td>
                        <td><span class="badge bg-secondary">@(item.CodigoInventario ?? "N/A")</span></td>
                        <td>@(item.NroSerie ?? "N/A")</td>
                        <td>
                            @if (item.Estado == "Nuevo")
                            {
                                <span class="badge badge-custom" style="background-color: var(--success-color);">
                                    <i class="bi bi-star-fill"></i> @item.Estado
                                </span>
                            }
                            else if (item.Estado == "En uso")
                            {
                                <span class="badge badge-custom" style="background-color: var(--secondary-color);">
                                    <i class="bi bi-check-circle-fill"></i> @item.Estado
                                </span>
                            }
                            else
                            {
                                <span class="badge badge-custom" style="background-color: var(--warning-color);">
                                    <i class="bi bi-exclamation-circle-fill"></i> @item.Estado
                                </span>
                            }
                        </td>
                        <td>@(item.FechaAlta?.ToString("dd/MM/yyyy") ?? "N/A")</td>
                        <td>
                            <span class="badge @(item.StockActual < item.StockMinimo ? "bg-danger" : "bg-success")">
                                @item.StockActual unidades
                            </span>
                        </td>
                        <td>@(item.IdMarcaNavigation?.Nombre ?? "Sin marca")</td>
                        <td>@(item.IdTipoNavigation?.Descripcion ?? "Sin tipo")</td>
                        <td class="text-center">
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-primary" onclick="abrirModalDetalle(@item.IdDispositivo)" title="Ver Detalles">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning-custom" onclick="abrirModalEditar(@item.IdDispositivo)" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-danger-custom" onclick="abrirModalEliminar(@item.IdDispositivo, '@item.Nombre')" title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @if (!Model.Any())
    {
        <div class="alert alert-info text-center">
            <i class="bi bi-info-circle"></i> No se encontraron dispositivos con los criterios de búsqueda especificados.
        </div>
    }
</div>

<!-- ============================= SECCIÓN COMPONENTES ============================= -->
<div class="card-custom p-4 mb-4" style="border-left: 4px solid var(--success-color);">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0" style="color: var(--success-color);">
            <i class="bi bi-gear-fill"></i> Componentes (Hardware Interno)
        </h3>
        <span class="badge bg-success" style="font-size: 1rem;">@(componentes?.Count() ?? 0) registros</span>
    </div>

    <div class="table-responsive">
        <table class="table table-custom table-hover">
            <thead style="background: var(--success-color);">
                <tr>
                    <th><i class="bi bi-tag"></i> Nombre</th>
                    <th><i class="bi bi-card-text"></i> Descripción</th>
                    <th><i class="bi bi-hash"></i> Nro. Serie</th>
                    <th><i class="bi bi-circle-fill"></i> Estado</th>
                    <th><i class="bi bi-bookmark"></i> Marca</th>
                    <th><i class="bi bi-cpu"></i> Tipo</th>
                    <th><i class="bi bi-calendar"></i> Fecha Instalación</th>
                    <th><i class="bi bi-box-seam"></i> Cantidad</th>
                    <th class="text-center"><i class="bi bi-gear"></i> Acciones</th>
                </tr>
            </thead>
            <tbody>
                @if (componentes != null && componentes.Any())
                {
                    @foreach (var comp in componentes)
                    {
                        <tr>
                            <td class="fw-bold">@comp.Nombre</td>
                            <td>@(comp.Descripcion ?? "Sin descripción")</td>
                            <td>
                                @if (!string.IsNullOrEmpty(comp.NroSerie))
                                {
                                    <code>@comp.NroSerie</code>
                                }
                                else
                                {
                                    <span class="text-muted">N/A</span>
                                }
                            </td>
                            <td>
                                @if (comp.Estado == "Nuevo")
                                {
                                    <span class="badge badge-custom" style="background-color: var(--success-color);">
                                        <i class="bi bi-star-fill"></i> @comp.Estado
                                    </span>
                                }
                                else if (comp.Estado == "En uso")
                                {
                                    <span class="badge badge-custom" style="background-color: var(--secondary-color);">
                                        <i class="bi bi-check-circle-fill"></i> @comp.Estado
                                    </span>
                                }
                                else
                                {
                                    <span class="badge badge-custom" style="background-color: var(--warning-color);">
                                        <i class="bi bi-exclamation-circle-fill"></i> @(comp.Estado ?? "N/A")
                                    </span>
                                }
                            </td>
                            <td>@(comp.IdMarcaNavigation?.Nombre ?? "Sin marca")</td>
                            <td>@(comp.IdTipoNavigation?.Descripcion ?? "Sin tipo")</td>
                            <td>@(comp.FechaInstalacion?.ToString("dd/MM/yyyy") ?? "N/A")</td>
                            <td>
                                <span class="badge bg-info">@comp.Cantidad</span>
                            </td>
                            <td class="text-center">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="abrirModalDetalleComponente(@comp.IdComponente)" title="Ver Detalles">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-warning-custom" onclick="abrirModalEditarComponente(@comp.IdComponente)" title="Editar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger-custom" onclick="abrirModalEliminarComponente(@comp.IdComponente, '@comp.Nombre')" title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    @if (componentes == null || !componentes.Any())
    {
        <div class="alert alert-info text-center">
            <i class="bi bi-info-circle"></i> No se encontraron componentes con los criterios de búsqueda especificados.
        </div>
    }
</div>

<!-- Modal Crear/Editar Dispositivos -->
<div class="modal fade" id="modalFormulario" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title" id="modalTitulo">
                    <i class="bi bi-plus-circle"></i> Nuevo Dispositivo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalContenido"></div>
        </div>
    </div>
</div>

<!-- Modal Detalle Dispositivos -->
<div class="modal fade" id="modalDetalle" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title">
                    <i class="bi bi-info-circle"></i> Detalles del Dispositivo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalDetalleContenido"></div>
        </div>
    </div>
</div>

<!-- Modal Eliminar Dispositivos -->
<div class="modal fade" id="modalEliminar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle"></i> Confirmar Eliminación
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro que desea eliminar el dispositivo <strong id="nombreDispositivo"></strong>?</p>
                <p class="text-muted small">Esta acción realizará un borrado lógico del registro.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger-custom" id="btnConfirmarEliminar">
                    <i class="bi bi-trash"></i> Eliminar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Crear Equipo -->
<div class="modal fade" id="createEquipoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title">Nuevo Equipo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body"></div>
        </div>
    </div>
</div>

<!-- Modal Componentes (Crear/Editar/Detalle/Eliminar) -->
<div class="modal fade" id="modalComponente" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: var(--success-color); color: white;">
                <h5 class="modal-title" id="modalComponenteTitulo"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: brightness(0) invert(1);"></button>
            </div>
            <div class="modal-body" id="modalComponenteContenido"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let dispositivoIdEliminar = null;
        let componenteIdEliminar = null;

        // ==================== FUNCIONES DISPOSITIVOS ====================
        function abrirModalCrear() {
            $('#modalTitulo').html('<i class="bi bi-plus-circle"></i> Nuevo Dispositivo');
            $.get('@Url.Action("Create", "Dispositivo")', function(data) {
                $('#modalContenido').html(data);
                $('#modalFormulario').modal('show');
            }).fail(function() {
                alert('Error al cargar el formulario');
            });
        }

        function abrirModalEditar(id) {
            $('#modalTitulo').html('<i class="bi bi-pencil"></i> Editar Dispositivo');
            $.get('@Url.Action("Edit", "Dispositivo")/' + id, function(data) {
                $('#modalContenido').html(data);
                $('#modalFormulario').modal('show');
            }).fail(function() {
                alert('Error al cargar el formulario');
            });
        }

        function abrirModalDetalle(id) {
            $.get('@Url.Action("Details", "Dispositivo")/' + id, function(data) {
                $('#modalDetalleContenido').html(data);
                $('#modalDetalle').modal('show');
            }).fail(function() {
                alert('Error al cargar los detalles');
            });
        }

        function abrirModalEliminar(id, nombre) {
            dispositivoIdEliminar = id;
            $('#nombreDispositivo').text(nombre);
            $('#modalEliminar').modal('show');
        }

        $('#btnConfirmarEliminar').click(function() {
            if (dispositivoIdEliminar) {
                $.ajax({
                    url: '@Url.Action("Delete", "Dispositivo")/' + dispositivoIdEliminar,
                    type: 'POST',
                    data: {
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val(),
                        id: dispositivoIdEliminar
                    },
                    success: function(response) {
                        if (response.success) {
                            $('#modalEliminar').modal('hide');
                            location.reload();
                        } else {
                            alert('Error al eliminar el dispositivo');
                        }
                    },
                    error: function() {
                        alert('Error al eliminar el dispositivo');
                    }
                });
            }
        });

        // Manejar submit del formulario de creación de dispositivos
        $(document).on('submit', '#formDispositivo', function(e) {
            e.preventDefault();
            var form = $(this);
            $.ajax({
                url: form.attr('action'),
                type: 'POST',
                data: form.serialize(),
                success: function(response) {
                    if (response.success) {
                        $('#modalFormulario').modal('hide');
                        location.reload();
                    } else {
                        $('#modalContenido').html(response);
                    }
                },
                error: function() {
                    alert('Error al procesar la solicitud');
                }
            });
        });

        // Manejar submit del formulario de edición de dispositivos
        $(document).on('submit', '#formDispositivoEdit', function(e) {
            e.preventDefault();
            var form = $(this);

            $.ajax({
                url: '@Url.Action("Edit", "Dispositivo")',
                type: 'POST',
                data: form.serialize(),
                success: function(response) {
                    if (response.success) {
                        $('#modalFormulario').modal('hide');
                        location.reload();
                    } else {
                        $('#modalContenido').html(response);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    console.log('Response:', xhr.responseText);
                    alert('Error al procesar la solicitud de edición');
                }
            });
        });

        // ==================== FUNCIONES COMPONENTES ====================
        function abrirModalCrearComponente() {
            $('#modalComponenteTitulo').html('<i class="bi bi-plus-circle"></i> Nuevo Componente');
            $.get('@Url.Action("Create", "Componente")', function(data) {
                $('#modalComponenteContenido').html(data);
                $('#modalComponente').modal('show');
            }).fail(function() {
                alert('Error al cargar el formulario de componente');
            });
        }

        function abrirModalEditarComponente(id) {
            $('#modalComponenteTitulo').html('<i class="bi bi-pencil"></i> Editar Componente');
            $.get('@Url.Action("Edit", "Componente")/' + id, function(data) {
                $('#modalComponenteContenido').html(data);
                $('#modalComponente').modal('show');
            }).fail(function() {
                alert('Error al cargar el formulario de edición');
            });
        }

        function abrirModalDetalleComponente(id) {
            $('#modalComponenteTitulo').html('<i class="bi bi-info-circle"></i> Detalles del Componente');
            $.get('@Url.Action("Details", "Componente")/' + id, function(data) {
                $('#modalComponenteContenido').html(data);
                $('#modalComponente').modal('show');
            }).fail(function() {
                alert('Error al cargar los detalles');
            });
        }

        function abrirModalEliminarComponente(id, nombre) {
            if (confirm('¿Está seguro que desea eliminar el componente "' + nombre + '"?')) {
                $.ajax({
                    url: '@Url.Action("Delete", "Componente")/' + id,
                    type: 'POST',
                    data: {
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            alert('Error al eliminar el componente');
                        }
                    },
                    error: function() {
                        alert('Error al procesar la solicitud');
                    }
                });
            }
        }

        // Manejar submit del formulario de componentes (crear)
        $(document).on('submit', '#formComponente', function(e) {
            e.preventDefault();
            var form = $(this);
            $.ajax({
                url: form.attr('action'),
                type: 'POST',
                data: form.serialize(),
                success: function(response) {
                    if (response.success) {
                        $('#modalComponente').modal('hide');
                        location.reload();
                    } else {
                        $('#modalComponenteContenido').html(response);
                    }
                },
                error: function() {
                    alert('Error al procesar la solicitud');
                }
            });
        });

        // Manejar submit del formulario de edición de componentes
        $(document).on('submit', '#formComponenteEdit', function(e) {
            e.preventDefault();
            var form = $(this);

            $.ajax({
                url: '@Url.Action("Edit", "Componente")',
                type: 'POST',
                data: form.serialize(),
                success: function(response) {
                    if (response.success) {
                        $('#modalComponente').modal('hide');
                        location.reload();
                    } else {
                        $('#modalComponenteContenido').html(response);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    console.log('Response:', xhr.responseText);
                    alert('Error al procesar la solicitud de edición');
                }
            });
        });

        // Modal Equipo
        $('#createEquipoModal').on('show.bs.modal', function () {
            var modal = $(this);
            modal.find('.modal-body').html('<div class="text-center py-4"><div class="spinner-border text-primary"></div></div>');
            $.get('/Dispositivo/CreateEquipo', function (data) {
                modal.find('.modal-body').html(data);
            });
        });

        $('#createEquipoModal').on('hidden.bs.modal', function () {
            $(this).find('.modal-body').empty();
        });
    </script>
}